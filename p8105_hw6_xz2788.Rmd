---
title: "p8105_hw6_xz2788"
author: "Xiaoyue Zhang"
date: "11/17/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

First load necessary packages

```{r}
library(tidyverse)
```

## Problem 1

Read in the raw data of homicides and parse columns

```{r read_data, message=FALSE, warning=FALSE}
homicide = read_csv(file = "./data/homicide-data.csv",
                    col_types = "cccccdcccddc")
```

### Tidy data

Create a city_state variable and a binary variable indicating whether the homicide is solved and tidy the dataset as required

```{r tidy_data}
homicide_tidy = homicide %>% 
  mutate(city_state = str_c(city, ",", state)) %>% 
  mutate(result = ifelse(disposition == "Closed by arrest", "solved", "unsolved")) %>% 
  filter(city_state != "Dallas,TX" & city_state != "Phoenix,AZ" & city_state != "Kansas City,MO" & city_state != "Tulsa,AL") %>% 
  mutate(victim_race = ifelse(victim_race == "White", "white", "non-white")) %>% 
  mutate(victim_race = as_factor(victim_race))

#relevel "race" factor, "white" as reference
homicide_tidy$victim_race = relevel(homicide_tidy$victim_race, ref = "white")
```

### Analysis in Baltimore

Fit a logistic regression model for Baltimore

```{r logistic_model}
#"unsolved" as reference group
homicide_tidy$result = relevel(as_factor(homicide_tidy$result), ref = "unsolved")
logi_balti = homicide_tidy %>% 
  filter(city_state == "Baltimore,MD") %>% 
  glm(result ~ victim_age + victim_sex + victim_race, data = ., family = "binomial") 
logi_balti %>%  broom::tidy()
```

Obtain the estimate and CI of OR

```{r extract_OR}
conf_inter = logi_balti %>% broom::confint_tidy()
logi_balti %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate)) %>% 
  select(term, OR, log_OR = estimate, p.value) %>% 
  cbind(., conf_inter) %>% 
  knitr::kable(digits = 3)
```

From the results, we can see that in Baltimore, for non-white victims, the odds of solving homicides and unsolved ones is 0.44 times the odds of that of white victims with adjusting for age and sex, which also means that homicides of white victims were more likely to be solved.

### Build logistic regression for each of the city

First creat a function to extract OR and 95%CI

```{r creat_function}
odds_confi = function(x){
  
  ci = broom::confint_tidy(x)
  or_ci = x %>% 
    broom::tidy() %>% 
    mutate(OR = exp(estimate)) %>% 
  select(term, OR, log_OR = estimate) %>% 
  cbind(., ci)
  
  return(or_ci)
  
}

```

Conduct glm in each city and delete "Unknown" victim sex for later modeling

```{r logit_city}
homicide_tidy %>% 
  filter(victim_sex != "Unknown") %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(model = map(data, ~glm(result ~ victim_age + victim_sex + victim_race, data = .x, family = "binomial"))) %>% 
  mutate(model = map(model, odds_confi)) %>% 
  select(-data) %>% 
  unnest()
```




