---
title: "p8105_hw6_xz2788"
author: "Xiaoyue Zhang"
date: "11/17/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

First load necessary packages

```{r}
library(tidyverse)
```

## Problem 1

Read in the raw data of homicides and parse columns

```{r read_data, message=FALSE, warning=FALSE}
homicide = read_csv(file = "./data/homicide-data.csv",
                    col_types = "cccccdcccddc")
```

### Tidy data

Create a city_state variable and a binary variable indicating whether the homicide is solved and tidy the dataset as required

```{r tidy_data}
homicide_tidy = homicide %>% 
  mutate(city_state = str_c(city, ",", state)) %>% 
  mutate(result = ifelse(disposition == "Closed by arrest", "solved", "unsolved")) %>% 
  filter(city_state != "Dallas,TX" & city_state != "Phoenix,AZ" & city_state != "Kansas City,MO" & city_state != "Tulsa,AL") %>% 
  mutate(victim_race = ifelse(victim_race == "White", "white", "non-white")) %>% 
  mutate(victim_race = as_factor(victim_race))

#relevel "race" factor, "white" as reference
homicide_tidy$victim_race = relevel(homicide_tidy$victim_race, ref = "white")
```

### Analysis in Baltimore

Fit a logistic regression model for Baltimore

```{r logistic_model}
#"unsolved" as reference group
homicide_tidy$result = relevel(as_factor(homicide_tidy$result), ref = "unsolved")
logi_balti = homicide_tidy %>% 
  filter(city_state == "Baltimore,MD") %>% 
  glm(result ~ victim_age + victim_sex + victim_race, data = ., family = "binomial") 
logi_balti %>%  broom::tidy()
```

Obtain the estimate and CI of OR

```{r extract_OR}
conf_inter = logi_balti %>% 
  broom::confint_tidy() %>% 
  mutate(conf.low = exp(conf.low), conf.high = exp(conf.high))
logi_balti %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate)) %>% 
  select(term, OR, log_OR = estimate, p.value) %>% 
  cbind(., conf_inter) %>% 
  knitr::kable(digits = 3)
```

From the results, we can see that in Baltimore, for non-white victims, the odds of solving homicides and unsolved ones is 0.44 times the odds of that of white victims with adjusting for age and sex, which also means that homicides of white victims were more likely to be solved.

### Build logistic regression for each of the city

First creat a function to extract OR and 95%CI

```{r creat_function}
odds_confi = function(x){
  
  ci = broom::confint_tidy(x) %>% 
    mutate(conf.low = exp(conf.low), conf.high = exp(conf.high))
  or_ci = x %>% 
    broom::tidy() %>% 
    mutate(OR = exp(estimate)) %>% 
  select(term, OR, log_OR = estimate) %>% 
  cbind(., ci)
  
  return(or_ci)
  
}

```

Conduct glm in each city and delete "Unknown" victim sex for later modeling

```{r logit_city}
each_city = homicide_tidy %>% 
  filter(victim_sex != "Unknown") %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(model = map(data, ~glm(result ~ victim_age + victim_sex + victim_race, data = .x, family = "binomial"))) %>% 
  mutate(model = map(model, odds_confi)) %>% 
  select(-data) %>% 
  unnest()
head(each_city)
```

Make a plot to show ORs and CIs for each city

```{r plot_each_city}
each_city %>% 
  filter(term == "victim_racenon-white") %>% 
  transform(city_state = reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(
    title = "Estimated odds ratio and 95% CI of race",
    x = "City",
    y = "Estimated odds ratio of race",
    caption = "Data from the Washington Post"
  ) +
  theme(legend.position = "bottom")
```

Comment: Across the cities, Boston has the lowest estimated odds ratio for solving homicides comparing non-white victims to white victims and Tampa, FL has the highes estimated odds ratio. Only Durham and Tampa have estimated odds ratio over 1 which means in these cities, homicides of non-white victims are more likely to be solved while all other cities were the opposite, but the confidence interval included 1 which meas actually no difference between the odds ration in non-white and white victims.

## Problem 2



