p8105\_hw6\_xz2788
================
Xiaoyue Zhang
11/17/2018

First load necessary packages

``` r
library(tidyverse)
```

    ## ── Attaching packages ───────────────────────────────────────────────── tidyverse 1.2.1 ──

    ## ✔ ggplot2 3.0.0     ✔ purrr   0.2.5
    ## ✔ tibble  1.4.2     ✔ dplyr   0.7.6
    ## ✔ tidyr   0.8.1     ✔ stringr 1.3.1
    ## ✔ readr   1.1.1     ✔ forcats 0.3.0

    ## ── Conflicts ──────────────────────────────────────────────────── tidyverse_conflicts() ──
    ## ✖ dplyr::filter() masks stats::filter()
    ## ✖ dplyr::lag()    masks stats::lag()

Problem 1
---------

Read in the raw data of homicides and parse columns

``` r
homicide = read_csv(file = "./data/homicide-data.csv",
                    col_types = "cccccdcccddc")
```

### Tidy data

Create a city\_state variable and a binary variable indicating whether the homicide is solved and tidy the dataset as required

``` r
homicide_tidy = homicide %>% 
  mutate(city_state = str_c(city, ",", state)) %>% 
  mutate(result = ifelse(disposition == "Closed by arrest", "solved", "unsolved")) %>% 
  filter(city_state != "Dallas,TX" & city_state != "Phoenix,AZ" & city_state != "Kansas City,MO" & city_state != "Tulsa,AL") %>% 
  mutate(victim_race = ifelse(victim_race == "White", "white", "non-white")) %>% 
  mutate(victim_race = as_factor(victim_race))

#relevel "race" factor, "white" as reference
homicide_tidy$victim_race = relevel(homicide_tidy$victim_race, ref = "white")
```

### Analysis in Baltimore

Fit a logistic regression model for Baltimore

``` r
#"unsolved" as reference group
homicide_tidy$result = relevel(as_factor(homicide_tidy$result), ref = "unsolved")
logi_balti = homicide_tidy %>% 
  filter(city_state == "Baltimore,MD") %>% 
  glm(result ~ victim_age + victim_sex + victim_race, data = ., family = "binomial") 
logi_balti %>%  broom::tidy()
```

    ## # A tibble: 4 x 5
    ##   term                 estimate std.error statistic  p.value
    ##   <chr>                   <dbl>     <dbl>     <dbl>    <dbl>
    ## 1 (Intercept)           1.19      0.235        5.06 4.30e- 7
    ## 2 victim_age           -0.00699   0.00326     -2.14 3.22e- 2
    ## 3 victim_sexMale       -0.888     0.136       -6.53 6.80e-11
    ## 4 victim_racenon-white -0.820     0.175       -4.69 2.68e- 6

Obtain the estimate and CI of OR

``` r
conf_inter = logi_balti %>% broom::confint_tidy()
logi_balti %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate)) %>% 
  select(term, OR, log_OR = estimate, p.value) %>% 
  cbind(., conf_inter) %>% 
  knitr::kable(digits = 3)
```

| term                  |     OR|  log\_OR|  p.value|  conf.low|  conf.high|
|:----------------------|------:|--------:|--------:|---------:|----------:|
| (Intercept)           |  3.274|    1.186|    0.000|     0.730|      1.651|
| victim\_age           |  0.993|   -0.007|    0.032|    -0.013|     -0.001|
| victim\_sexMale       |  0.412|   -0.888|    0.000|    -1.156|     -0.622|
| victim\_racenon-white |  0.441|   -0.820|    0.000|    -1.164|     -0.479|

From the results, we can see that in Baltimore, for non-white victims, the odds of solving homicides and unsolved ones is 0.44 times the odds of that of white victims with adjusting for age and sex, which also means that homicides of white victims were more likely to be solved.

### Build logistic regression for each of the city

First creat a function to extract OR and 95%CI

``` r
odds_confi = function(x){
  
  ci = broom::confint_tidy(x)
  or_ci = x %>% 
    broom::tidy() %>% 
    mutate(OR = exp(estimate)) %>% 
  select(term, OR, log_OR = estimate) %>% 
  cbind(., ci)
  
  return(or_ci)
  
}
```

Conduct glm in each city and delete "Unknown" victim sex for later modeling

``` r
homicide_tidy %>% 
  filter(victim_sex != "Unknown") %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(model = map(data, ~glm(result ~ victim_age + victim_sex + victim_race, data = .x, family = "binomial"))) %>% 
  mutate(model = map(model, odds_confi)) %>% 
  select(-data) %>% 
  unnest()
```

    ## # A tibble: 188 x 6
    ##    city_state     term                    OR   log_OR conf.low conf.high
    ##    <chr>          <chr>                <dbl>    <dbl>    <dbl>     <dbl>
    ##  1 Albuquerque,NM (Intercept)          3.62   1.29      0.541   2.07    
    ##  2 Albuquerque,NM victim_age           0.976 -0.0244   -0.0390 -0.0106  
    ##  3 Albuquerque,NM victim_sexMale       1.58   0.455    -0.116   1.02    
    ##  4 Albuquerque,NM victim_racenon-white 0.738 -0.304    -0.806   0.191   
    ##  5 Atlanta,GA     (Intercept)          3.17   1.15      0.454   1.87    
    ##  6 Atlanta,GA     victim_age           0.988 -0.0118   -0.0208 -0.00287 
    ##  7 Atlanta,GA     victim_sexMale       0.990 -0.0101   -0.392   0.364   
    ##  8 Atlanta,GA     victim_racenon-white 0.753 -0.284    -0.857   0.262   
    ##  9 Baltimore,MD   (Intercept)          3.27   1.19      0.730   1.65    
    ## 10 Baltimore,MD   victim_age           0.993 -0.00699  -0.0134 -0.000627
    ## # ... with 178 more rows
